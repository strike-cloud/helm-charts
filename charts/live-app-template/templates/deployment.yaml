{{- if or (eq .Values.type "app") (eq .Values.type "worker") }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.appName }}
  namespace: {{ .Values.namespace }}
  labels:
    app: {{ .Values.appName }}
    env: {{ .Values.envShort }}
  annotations:
    link.argocd.argoproj.io/repository: 'Repository|https://github.com/strikesecurity/{{ .Release.Name }}'
    link.argocd.argoproj.io/repository-actions: 'Repository|https://github.com/strikesecurity/{{ .Release.Name }}.git/actions'

spec:
  progressDeadlineSeconds: 300
  revisionHistoryLimit: 3
{{- if not .Values.hpa.enabled }}
  replicas: {{ .Values.replicaCount | default 1 }}
{{- end }}
  selector:
    matchLabels:
      app:  {{ .Values.appName }}
  strategy:
    type: {{ .Values.deployment.strategy }}
    rollingUpdate:
      maxUnavailable: {{ if eq (int .Values.replicaCount) 1 }}0{{ else }}1{{ end }}
      maxSurge: {{ if eq (int .Values.replicaCount) 1 }}1{{ else }}0{{ end }}
  template:
    metadata:
      labels:
        app:  {{ .Values.appName }}
        env: {{ .Values.envShort }}
        version: {{ .Values.appVersion | quote  }}
        # timestamp: "{{ date "20060102150405" now }}"
      annotations:
        # timestamp: "{{ date "20060102150405" now }}"
        elastic.co/dataset: kubernetes.container_logs.apps
        elastic.co/namespace: apps
    spec:
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: "kubernetes.io/hostname"
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: {{ .Values.appName }}
              # timestamp: {{ date "20060102150405" now | quote }}
      terminationGracePeriodSeconds: 60
      containers:
      - name:  {{ .Values.appName }}
        {{- if contains "/" .Values.image }}
        image: {{ .Values.image }}:{{ .Values.appVersion }}
        {{- else }}
        image: {{ .Values.image }}/{{ .Values.appName }}:{{ .Values.appVersion }}
        {{- end }}
        imagePullPolicy: {{.Values.imagePullPolicy}}
        {{- if or (.Values.configmap.enabled) (.Values.secrets.enabled) }}
        volumeMounts:
          {{- if .Values.configmap.enabled }}
          - mountPath: /etc/configmap
            name: cm-volume
          {{- end }}
          {{- if .Values.secrets.enabled }}
          - mountPath: /etc/secrets
            name: {{ if .Values.secrets.appName }}{{ .Values.secrets.appName }}{{ else }}{{ .Values.appName }}{{ end }}
          {{- end }}
          {{- if .Values.resources.volume.enabled }}
          - mountPath: {{ .Values.resources.volume.mountPath | default "/mnt/app-data" }}
            name: {{ .Values.appName }}-data
          {{- end }}
        {{- end }}
        resources:
          limits:
            {{- if .Values.resources.limits.cpu}}
            cpu: "{{ .Values.resources.limits.cpu }}"
            {{- end }}
            memory: "{{ .Values.resources.limits.memory }}"
          requests:
            cpu: "{{ .Values.resources.requests.cpu }}"
            memory: "{{ .Values.resources.requests.memory }}"
        ports:
        {{- range .Values.service.ports }}
        - name: {{ .name | default "http" }}
          containerPort: {{ .targetPort }}
          protocol: {{ .protocol | default "TCP" }}
        {{- end }}
        readinessProbe:
          successThreshold: {{ .Values.healthcheck.readinessSuccess }}
          failureThreshold: {{ .Values.healthcheck.readinessFailure }}
          {{- if eq ( .Values.healthcheck.type ) "http" }}
          httpGet:
            path: {{ .Values.healthcheck.path }}
            port: {{ (index .Values.service.ports 0).targetPort }}
          {{- end }}
          {{- if eq ( .Values.healthcheck.type) "command"}}
          exec:
            command:
              - /bin/sh
              - -c
              - {{ .Values.healthcheck.command }}
          {{- end }}
          initialDelaySeconds: {{ .Values.healthcheck.readinessDelay }}
          periodSeconds: {{ .Values.healthcheck.period }}
          timeoutSeconds: {{ .Values.healthcheck.timeout }}
        livenessProbe:
          successThreshold: {{ .Values.healthcheck.livenessSuccess }}
          failureThreshold: {{ .Values.healthcheck.livenessFailure }}
          {{- if eq ( .Values.healthcheck.type ) "http" }}
          httpGet:
            path: {{ .Values.healthcheck.path }}
            port: {{ (index .Values.service.ports 0).targetPort }}
          {{- end }}
          {{- if eq ( .Values.healthcheck.type) "command"}}
          exec:
            command:
              - /bin/sh
              - -c
              - {{ .Values.healthcheck.command }}
          {{- end }}
          initialDelaySeconds: {{ .Values.healthcheck.livenessDelay }}
          periodSeconds: {{ .Values.healthcheck.period }}
          timeoutSeconds: {{ .Values.healthcheck.timeout }}
        startupProbe:
          {{- if eq ( .Values.healthcheck.type ) "http" }}
          httpGet:
            path: {{ .Values.healthcheck.path }}
            port: {{ (index .Values.service.ports 0).targetPort }}
          {{- end }}
          {{- if eq ( .Values.healthcheck.type) "command"}}
          exec:
            command:
              - /bin/sh
              - -c
              - {{ .Values.healthcheck.command }}
          {{- end }}
          failureThreshold: 30
          periodSeconds: {{ .Values.healthcheck.period }}
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "kill -TERM 1 && while kill -0 1 2>/dev/null; do sleep 1; done"]
        env:
        {{- range $key, $value := .Values.environments }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}
      {{- if .Values.noInterrupt.enabled }}
      # No-interrupt protection sidecar
      - name: no-interrupt
        image: {{ .Values.noInterrupt.sidecar.image }}
        imagePullPolicy: Always
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        resources:
          requests:
            cpu: {{ .Values.noInterrupt.sidecar.resources.requests.cpu }}
            memory: {{ .Values.noInterrupt.sidecar.resources.requests.memory }}
          limits:
            cpu: {{ .Values.noInterrupt.sidecar.resources.limits.cpu }}
            memory: {{ .Values.noInterrupt.sidecar.resources.limits.memory }}
        volumeMounts:
        - mountPath: /tmp
          name: tmp-shared
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
      {{- end }}
      {{- if or (.Values.configmap.enabled) (.Values.secrets.enabled) (.Values.noInterrupt.enabled) }}
      volumes:
        {{- if .Values.configmap.enabled }}
        - name: cm-volume
          configMap:
            name: {{ .Values.configmap.name }}
        {{- end }}
        {{- if .Values.secrets.enabled }}
        - name: {{ if .Values.secrets.appName }}{{ .Values.secrets.appName }}{{ else }}{{ .Values.appName }}{{ end }}
          secret:
            secretName: {{ if .Values.secrets.appName }}{{ .Values.secrets.appName }}{{ else }}{{ .Values.appName }}{{ end }}
        {{- end }}
        {{- if .Values.resources.volume.enabled }}
        - name: {{ .Values.appName }}-data
          persistentVolumeClaim:
            claimName: {{ .Values.appName }}-pvc
        {{- end }}
        {{- if .Values.noInterrupt.enabled }}
        - name: tmp-shared
          emptyDir: {}
        {{- end }}
      {{- end }}{{- end }}